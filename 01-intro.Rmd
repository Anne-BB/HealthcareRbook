# Introduction to R {#intro}
This book takes on a non-traditional approach to teaching R. It emphasises learning R by examples. Often data science course spend time explaining how R treat data as vector and manipulate data symbolically. Data manipulation is the foundation of data science but can bore those new to R. That aspect is left to the next chapter on data wrangling. This chapter is an introduction to _ggplot2_. Another aspect of learning R is that the libraries come with many free dataset. Clinicians do not find the _diamond_ or _car_ or _gapminder_ datasets useful as they are not related to medicine. On the other hand, the actual _Titanic_ data, with passenger list and their fate, may be of interest. In this book we will try to use dataset which are directly related to medicine or topics of high interest such as the COVID-19 data. Some of the data provided here comes from publications by the Neurology Department, some are simulated and some have come from the internet (COVID-19) and some dataset are provided by R (eg lung cancer, leukemia). The dataset available in R in the following packages _datasets_ and _Stat2Data_ . Researchers working on animal dataset may find the principles of analysis described here useful for animal research. Unless indicated, the data use in this book can be found in the _Data-Use_ folder. 

## ggplot2

The plot below uses _ggplot2_ or grammar of graphics. The plot is built layer by layer like constructing a sentence. Plotting is a distinct advantage of R over commercial software with GUI (graphical user interface) like _SPSS_. The plot has a certain structure. The ggplot statement contains the data and aesthetics. For illustration purpose the aesthetics are labelled with x and y statements. The fill argument in the aesthetics indicate the variables for coloring. The colors chosen for this graph were imposed by the journal _Epilepsia_ [@pmid30577087]. To run the examples, check that you have install the libraries. an error can occurred if you don't have the required library. The metacharacter _#_ is used to signalled that the line is meant to comment the code ie R will not read it. The _install.packages_ command only need to be run once.   

### Histogram

```{r histogram}
library(ggplot2)
library(Stat2Data)
data("Leukemia")
ggplot(data=Leukemia,aes(Age,colour=as.factor(Resp)))+geom_histogram(bins=8)
```

### Bar plot

```{r  bar plot}
library(ggplot2)
library(extrafont)
##                              Lower  Upper
##                    percentage 0.95   0.95  
## Duration_PNES.lmg  0.0974     0.0057 0.2906
## pseudostatus.lmg   0.2283     0.0687 0.3753
## Hx_anxiety.lmg     0.0471     0.0057 0.1457
## Hx_depression.lmg  0.0059     0.0041 0.1082
## DSP.lmg            0.0582     0.0071 0.1500
## seizure_burden.lmg 0.0179     0.0041 0.1058
## sex.lmg            0.0413     0.0030 0.1519
df<-data.frame("Predictors"=c("Duration_PNES","pseudostatus","Hx_anxiety","Hx_depression","DSP","seizure_burden","sex"),"Importance"=c(0.09737,0.22825, 0.047137,0.00487,0.058153,0.01786,0.04131),"Lower.95"=c(0.0057,0.0687,0.0057,0.0041,0.0071,0.0041,0.0030),"Upper.95"=c(0.2906,0.3753,0.1457,0.1082,0.1500,0.1058,0.1519))
#dimensions of data frame
dim(df)
#variables in data frame
colnames(df)
#bar plot uses geom_bar 
ggplot(df, aes(x=Predictors,y=Importance))+geom_bar(stat="identity")
#reordering the data
df3<-df2<-df
df3$Predictors<-factor(df2$Predictors, levels=df2[order(df$Importance),"Predictors"])
#adding color
p<-ggplot(df3, aes(x=Predictors,y=Importance,fill=Predictors))+geom_bar(colour="black",stat="identity",fill=c("#e4b84b","#ce8080","#511c23","#e37c1d","#ffde75","#abb47d","#a1c5cb"))
p
#rotate legend on x axis label by 45
p+theme(axis.title.y = element_text(face="bold",  size=12),axis.title.x = element_text(face="bold", size=12), axis.text.x  = element_text(angle=45, vjust=0.5, size=12))

p1<-p+geom_errorbar(aes(ymin=Lower.95,ymax=Upper.95,width=0.2))+labs(y="R2 exaplained (%)")+
  theme(text=element_text(size=12))+ggtitle(" Relative Importance of Regressors for Cost among patients with non-epileptic seizure")
p1
```
### Scatter plot

The above data is used here to illustrate scatter plot. We can denote the color difference among the Predictors by adding _color_ argument in the _aesthetics_. 

```{r scatter plot}
#color
ggplot(df3, aes(x=Predictors,y=Importance,color=Predictors))+geom_point()+theme(axis.title.y = element_text(face="bold",  size=12),axis.title.x = element_text(face="bold", size=12), axis.text.x  = element_text(angle=45, vjust=0.5, size=12))
#size
ggplot(df3, aes(x=Predictors,y=Importance,color=Predictors,size=Predictors))+geom_point()+theme(axis.title.y = element_text(face="bold",  size=12),axis.title.x = element_text(face="bold", size=12), axis.text.x  = element_text(angle=45, vjust=0.5, size=12))
```

### Line plot
The data below is generated in the section on data simulation. The data were simulated using summary data from recent clot retrieval trials in stroke [@pmid25517348,@pmid25671797]

```{r line plot}
library(ggplot2)
library(tidyverse)
dtTime<-read.csv("./Data-Use/dtTime_simulated.csv")
dtTrial<-read.csv("./Data-Use/dtTrial_simulated.csv")
#summarise data using group_by
dtTime2<-dtTime %>%
  group_by(period, T) %>%
  summarise(meanY=mean(Y),
            sdY=sd(Y),
            upperY=meanY+sdY,
            lowerY=meanY-sdY)
#individual line plot
ggplot(dtTime,aes(x=as.factor(period),y=Y))+geom_line(aes(color=as.factor(T),group=id))+scale_color_manual(values = c("#e38e17", "#8e17e3")) + xlab("Time")+ylab("NIHSS")
#box plot
gg<-ggplot(dtTime,aes(x=as.factor(period),y=Y))+geom_boxplot(aes(color=as.factor(T)))+  xlab("Time")+ylab("NIHSS")
gg+scale_fill_discrete(name="Treatment")
#linear regression Y1 predict Y2
fit<-lm(Y1~Y0+T, data=dtTrial)
dtTrial2<-filter(dtTrial, T==1)
fit2<-lm(Y2~Y1, data=dtTrial2)
#line plot by group
pd <- position_dodge2(width = 0.2) # move them .2 to the left and right
gbase  = ggplot(dtTime2, aes(y=meanY, colour=as.factor(T))) + geom_errorbar(aes(ymin=lowerY, ymax=upperY), width=.3, position=pd)+
geom_point(position=pd) 
gline = gbase + geom_line(position=pd) 
print(gline + aes(x=period))
dtTime2$period=as.numeric(dtTime2$period)
unique((dtTime2$period))
gline = gline %+% dtTime2
print(gline + aes(x=period))
```

### Facet wrap
Facet wrap is a good way to visually explore different aspects pf the data. Using the dtTime data above, the plots are separated by trial assignment.

```{r facet}
ggplot(dtTime,aes(x=as.factor(period),y=Y))+geom_line(aes(color=as.factor(T),group=id))+scale_color_manual(values = c("#e38e17", "#8e17e3"))+ facet_wrap(~T)+ xlab("Time")+ylab("NIHSS")
```

### Polygons

```{r polygon}
ggplot(dtTime,aes(x=as.factor(period),y=Y))+
  geom_point()+
  geom_polygon(mapping=aes(x=as.factor(period), y=Y, group=as.factor(T),fill=as.factor(T)))+ 
  xlab("Time")+ylab("NIHSS")
```

### Gganimate
The library _gganimate_ can be used to generate videos in the form of gif file. The data needs to be collated from wide to long format.

```{r eval=FALSE}
library(ggplot2)
library(gganimate)
#ensure data in long format, Y =NIHSS
u <- ggplot(dtTime2, aes(period, meanY , color = T, frame = period)) +
  geom_bar(stat="identity") +
  #scale_size(range = c(1, 5)) +
  geom_text(aes(x = 11.9, label = period), hjust = 0) +   xlim(0,13)+
  coord_cartesian(clip = 'off') + 
  facet_wrap(~meanY)+
  labs(title = 'ECR Trials', y = 'Number') +
transition_reveal(period)
u
#create gif
#animate(u,fps=15,duration=15)
#anim_save(u,file="./Data-Use/simulated_ECR_trial.gif", width=800, height=800)
```

### Map 

#### Thematic map
The _ggplot2_ library can also be used to generate thematic (choropleth) map. In the simple example below we will generate a map of Australian State territories color by size of area. The _ggplot2_ combines with _sf_ library and uses the shape file data in the _geom_sf_ call. This section will be expanded further in the _Geospatial Analysis_ chapter.

```{r Australian map}
library(ggplot2)
library(sf)
#shape file
Aust<-st_read("./Data-Use/GCCSA_2016_AUST.shp") 
colnames(Aust) #find out column variables
ggplot() + 
  geom_sf(data=Aust,aes(fill=AREASQKM16))+
  labs(x="Longitude (WGS84)", y="Latitude", title="Map of Australia") + 
  theme_bw() 
```

#### Voronoi
The _ggplot2_ and _sf_ libraries are extended to include drawing of voronoi. Voronoi is a special type of polygon. It can be seen as a mathematical approach to partition regions such that all points within the polygons are closest (depending on distance metrics) to the seed points. Voronoi has been used in disease mapping (John Snow mapping of Broad Street Cholera outbreak) and meteorology (Alfred Thiessen polygon method for measuring rainfall in basin). This is a more complex coding task. It uses the _geom_voronoi_ call from _gggvoronoi_ library. Some libraries have vignettes to help you implement the codes. The vignette in the _ggvoronoi_ library can be called using _vignette("ggvoronoi")_. The _osmdata_ library will be used to provide map from OpenStreetMap. A related library is _OpenStreetMap_. The latter library uses raster file whereas _osmdata_ provides vectorised map data. In the chapter on Geospatial Analysis we will expand on this theme with interactive map.

```{r voronoi}
#library(dismo)
library(dplyr)
library(ggvoronoi)
library(ggplot2)
library(sf)
#subset data with dplyr for metropolitan melbourne
msclinic<-read.csv("./Data-Use/msclinic.csv") %>% filter(clinic==1, metropolitan==1)
Victoria<-st_read("./Data-Use/GCCSA_2016_AUST.shp") %>% filter(STE_NAME16=="Victoria") 
m<-ggplot(msclinic)+
  geom_point(aes(x=lon,y=lat))+ #add hospital location
  geom_voronoi(aes(x=lon,y=lat,fill=distance),fill=NA, color="black")+ #create voronoi from hospital location
  geom_sf(data=Victoria,aes(fill=AREASQKM16)) +
  labs(x="Longitude (WGS84)", y="Latitude", title="Voronoi Map of MS Clinics in Melbourne")
m  
```


### Heatmap
The _ggplot2_ library can also be used for creating heatmap. This plot uses the _geom_tile_ function.

```{r heatmap}
library(ggplot2)
library(datasets)
library(plyr)
library(reshape)
library(scales)
data(swiss) #swiss fertility dataset from 1888
swiss$swiss_canton<-row.names(swiss) #assign column name to row name
rownames(swiss)<-NULL #remove row name
data.m <- melt(swiss)
 data.m <- ddply(data.m, .(variable), transform, rescale = rescale(value))
 q <- ggplot(data.m, aes(variable, swiss_canton)) + 
         geom_tile(aes(fill = rescale), colour = "white")+
        scale_fill_gradient(low = "white", high = "steelblue")+
   ggtitle("Swiss Fertility Data 1888")
 q
```

### Alluvial and Sankey diagram
The first known Sankey flow diagram with the arrow used to indicate the flow rate. It is often used to indicate energy dissipation in the system. There are several libraries providing Sankey plot such as _networkD3_ library. The _ggalluvial_ library is chosen here for demonstration as it forms part of the _ggplot2_ framework. 

```{r sankey}
library(ggalluvial)
library(Stat2Data)
data("Leukemia") #treatment of leukemia
#partition Age into 8 ordered factors
Leukemia$AgeCat<-cut_interval(Leukemia$Age, n=8, ordered_result=TRUE)
#axis1
ggplot(data=Leukemia, aes (y=Smear,axis1=AgeCat, axis2=Resp,axis3=Status))+
  geom_alluvium(aes(fill=AgeCat),width = 1/12)+
  geom_label(stat = "stratum", infer.label = TRUE) +
  geom_label(stat = "stratum", infer.label = TRUE)+
  scale_x_discrete(limits = c("AgeCat","Resp", "Status"),label=c("Age Category","Treatment Response","Mortality"), expand = c(.1, .1)) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Outcome after Leukemia Treatment")
```

## plotly
Plotly has its own API and uses _Dash_ to upload the figure on the web. It has additional ability for interaction as well as create a video. Examples are provided with calling plotly directly or via _ggplot2_. In the examples below, the plots are performed using _ggplot2_ and then pass onto _plotly_ using _ggplotly_ function. The example uses the Leukemia dataset from _Stat2Data_ library. 

```{r plotly}
library(plotly)
library(Stat2Data)
data("Leukemia") #treatment of leukemia
#scatter plot directly from plotly
plot_ly(x=~Age,y=~Smear, #percentage of blast
        color=~as.factor(Status),  #dead or alive
        symbol=~Resp, 
        symbols=c('circle' ,'square'), #Response to treatment
        data=Leukemia) 
#call from ggplot2
#using the epilepsy data in p generated above for bar plot
ggplotly(p) 
#using swiss data above to create heatmap
ggplotly(q) 


```


## Survival plot
The _survminer_ library extends _ggplot2_ style to survival plot. It requires several libraries such as _survival_ for survival analysis and _lubridate_ to parse time. 

```{r survival}
library(survminer)
library(lubridate)
library(survival)
data("lung") 
#data from survival package on NCCTG lung cancer trial
#https://stat.ethz.ch/R-manual/R-devel/library/survival/html/lung.html
#time in days
#status cesored=1, dead=2sex:
#sex:Male=1 Female=2
sfit<- survfit(Surv(time, status) ~ sex, data = lung)
ggsurvplot(sfit, data=lung,
           surv.median.line = "hv",
           pval=TRUE,
           pval.size=3, 
           conf.int = TRUE,
           legend.labs=c("Male","Female"),xlab="Time (Days)", 
           break.time.by=.5,
           font.x=5,
           font.y=5)
```

## ggraph and tidygraph
The _igraph_ library does the heavy lifting in graph theory analysis. This aspect will be expanded on in the chapter on Graph Theory. However, the plotting function with _igraph_ is still not optimal. The _ggraph_ and _tidygraph_ libraries extend the _ggplot2_ style to graph.

```{r ggraph}
library(tidygraph)
library(ggraph) 
#relationship among members of acute stroke team
tpa<-readr::read_csv("./Data-Use/TPA_edge010817.csv")%>%
  rename(from=V1, to=V2)
#node by degree centrality
graph<-as_tbl_graph(tpa) %>%  mutate(degree = centrality_degree())
ggraph(graph, layout = 'fr') + 
 geom_edge_link() + 
  geom_node_point(aes(size=degree))
```

You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].
